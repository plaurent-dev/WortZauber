<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Geographie Spiel - Deutsche St√§dte</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="styles.css?v=1.0.5">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Fira Sans', sans-serif;
        }

        #map {
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
            pointer-events: auto;
        }

        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 50;
        }

        .game-header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            z-index: 101;
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            min-width: 350px;
        }

        .game-header h2 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
            color: #ffc107;
            border: none;
        }

        .city-name {
            font-size: 2.5em;
            font-weight: 700;
            color: white;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .game-stats {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.95em;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #ffc107;
        }

        .game-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(30, 30, 30, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            z-index: 101;
            pointer-events: auto;
            font-size: 0.95em;
        }

        .difficulty-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(30, 30, 30, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            z-index: 101;
            pointer-events: auto;
        }

        .difficulty-selector div {
            margin-bottom: 10px;
        }

        .difficulty-selector div:last-child {
            margin-bottom: 0;
        }

        .difficulty-selector select {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
        }

        .back-btn-game {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(30, 30, 30, 0.9);
            color: white;
            border: 2px solid #ffc107;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 102;
            text-decoration: none;
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }

        .back-btn-game:hover {
            background: #ffc107;
            color: #333;
        }

        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            z-index: 1000;
            display: none;
            pointer-events: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, -40%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #4caf50;
            color: white;
        }

        .feedback.incorrect {
            background: #f44336;
            color: white;
        }

        .feedback h3 {
            margin: 0 0 10px 0;
            font-size: 2em;
            border: none;
        }

        .feedback p {
            margin: 10px 0;
            font-size: 1.1em;
            color: inherit;
        }

        .feedback button {
            margin-top: 20px;
            padding: 10px 30px;
            background: white;
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
        }

        .results-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(30, 30, 30, 0.95);
            color: white;
            display: none;
            z-index: 2000;
            pointer-events: auto;
            overflow-y: auto;
            padding: 40px 20px;
        }

        .results-screen.show {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .results-content {
            max-width: 600px;
            text-align: center;
        }

        .results-content h2 {
            font-size: 2.5em;
            color: #ffc107;
            margin-bottom: 20px;
            border: none;
        }

        .final-score {
            font-size: 3em;
            font-weight: 700;
            color: #ffc107;
            margin: 30px 0;
        }

        .score-breakdown {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
        }

        .score-item.correct {
            color: #4caf50;
        }

        .score-item.incorrect {
            color: #f44336;
        }

        .results-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .results-buttons button {
            padding: 15px 30px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-restart {
            background: #ffc107;
            color: #333;
        }

        .btn-restart:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .btn-home {
            background: #667eea;
            color: white;
        }

        .btn-home:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="game-overlay">
        <a href="index.html" class="back-btn-game">‚Üê Zur√ºck</a>
        
        <div class="game-header">
            <h2>üó∫Ô∏è Deutsche St√§dte finden</h2>
            <div class="city-name" id="cityName">Loading...</div>
            <div class="game-stats">
                <div class="stat">
                    <div class="stat-label">Fragen</div>
                    <div class="stat-value"><span id="current">0</span>/<span id="total">20</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">Punkte</div>
                    <div class="stat-value" id="scoreDisplay">0</div>
                </div>
            </div>
        </div>

        <div class="game-info">
            üí° Klicke auf der Karte, um die Stadt zu finden!
        </div>

        <div class="difficulty-selector">
            <div>
                <label for="gameMode">Mode:</label>
                <select id="gameMode" onchange="changeGameMode(this.value)">
                    <option value="normal">Normal (Pas d'indices)</option>
                    <option value="easy">Facile (Points jaunes)</option>
                    <option value="super_easy">Super facile (Indices au survol)</option>
                </select>
            </div>
            <div style="margin-top: 10px;">
                <label for="difficulty">Difficult√©:</label>
                <select id="difficulty" onchange="changeDifficulty(this.value)">
                    <option value="easy">Einfach (50km)</option>
                    <option value="medium" selected>Mittel (30km)</option>
                    <option value="hard">Schwer (15km)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="feedback" id="feedback">
        <h3 id="feedbackTitle">Korrekt!</h3>
        <p id="feedbackText">Gro√üartig!</p>
        <button onclick="nextCity()">Weiter ‚Üí</button>
    </div>

    <div class="results-screen" id="resultsScreen">
        <div class="results-content">
            <h2>üéâ Spiel vorbei!</h2>
            <div class="final-score" id="finalScore">0</div>
            <p>von 2000 m√∂glichen Punkten</p>
            
            <div class="score-breakdown" id="scoreBreakdown"></div>
            
            <div class="results-buttons">
                <button class="btn-restart" onclick="restartGame()">üîÑ Nochmal spielen</button>
                <button class="btn-home" onclick="window.location.href='index.html'">üè† Startseite</button>
            </div>
        </div>
    </div>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYnaelzF3AanXmOGDG8j9kv3GyETYf1Js"></script>
    <script>
        // Attendre que Google Maps soit charg√©
        function waitForGoogleMaps() {
            if (typeof google !== 'undefined' && google.maps) {
                initMap();
            } else {
                setTimeout(waitForGoogleMaps, 100);
            }
        }
        
        document.addEventListener('DOMContentLoaded', waitForGoogleMaps);
    </script>
    <script>
        // Les 20 plus grandes villes allemandes avec coordonn√©es
        const cities = [
            { name: 'Berlin', lat: 52.5200, lng: 13.4050, population: '3.6M' },
            { name: 'Munich', lat: 48.1351, lng: 11.5820, population: '1.5M' },
            { name: 'Cologne', lat: 50.9375, lng: 6.9603, population: '1.1M' },
            { name: 'Frankfurt', lat: 50.1109, lng: 8.6821, population: '753k' },
            { name: 'Hamburg', lat: 53.5511, lng: 9.9937, population: '1.9M' },
            { name: 'Dusseldorf', lat: 51.2277, lng: 6.7735, population: '621k' },
            { name: 'Dortmund', lat: 51.5136, lng: 7.4653, population: '586k' },
            { name: 'Essen', lat: 51.4556, lng: 7.0116, population: '582k' },
            { name: 'Leipzig', lat: 51.3397, lng: 12.3731, population: '614k' },
            { name: 'Dresden', lat: 51.0504, lng: 13.7373, population: '556k' }
        ];

        let gameState = {
            currentCityIndex: 0,
            score: 0,
            difficulty: 'medium',
            answers: [],
            map: null,
            currentMarker: null,
            toleranceRadius: { easy: 50, medium: 30, hard: 15 },
            isWaitingForFeedback: false,
            cityMarkers: [],
            gameMode: 'normal'  // 'normal', 'easy', 'super_easy'
        };

        let map;
        let searchCircle;
        let userMarker;

        function initMap() {
            // Centre sur l'Allemagne
            const germanCenter = { lat: 51.1657, lng: 10.4515 };
            
            // Style de carte avec fronti√®res visibles
            const styledMapType = new google.maps.StyledMapType(
                [
                    { elementType: 'labels', stylers: [{ visibility: 'off' }] },
                    { featureType: 'administrative.country', elementType: 'geometry.stroke', stylers: [{ color: '#333333' }, { weight: 2 }] },
                    { featureType: 'administrative.province', elementType: 'geometry.stroke', stylers: [{ color: '#cccccc' }, { weight: 1 }] },
                    { featureType: 'water', stylers: [{ color: '#b3d9ff' }, { lightness: 20 }] },
                    { featureType: 'landscape', stylers: [{ color: '#f5f5f5' }, { lightness: 25 }] },
                    { featureType: 'road', stylers: [{ visibility: 'off' }] },
                    { featureType: 'poi', stylers: [{ visibility: 'off' }] }
                ],
                { name: 'Clean Germany Map' }
            );
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 6.5,
                center: germanCenter,
                mapTypeId: 'styled_map',
                gestureHandling: 'cooperative',
                mapTypeControlOptions: {
                    mapTypeIds: ['styled_map']
                }
            });

            map.mapTypes.set('styled_map', styledMapType);

            gameState.map = map;

            // Click handler pour les clics utilisateur
            map.addListener('click', function(event) {
                handleMapClick(event.latLng);
            });

            displayCurrentCity();
        }

        function displayCityMarkers() {
            // Nettoyer les anciens marqueurs
            gameState.cityMarkers.forEach(marker => marker.setMap(null));
            gameState.cityMarkers = [];

            // Afficher les marqueurs: tous en mode facile/super_easy, rien en mode normal
            cities.forEach((city, index) => {
                const shouldShowMarker = (gameState.gameMode === 'easy' || gameState.gameMode === 'super_easy');
                
                if (shouldShowMarker) {
                    const cityName = city.name;
                    const showTooltip = gameState.gameMode === 'super_easy';
                    
                    const infowindow = new google.maps.InfoWindow({
                        content: `<div style="color: #333; font-weight: bold;">${cityName}</div>`
                    });

                    // Tous les points en jaune (m√™me la ville cherch√©e)
                    const marker = new google.maps.Marker({
                        position: { lat: city.lat, lng: city.lng },
                        map: map,
                        title: showTooltip ? cityName : '',  // Affiche le tooltip seulement en super_easy
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 6,
                            fillColor: '#FFD700',
                            fillOpacity: 0.8,
                            strokeColor: '#FFA500',
                            strokeWeight: 2
                        },
                        opacity: 0.8
                    });

                    // Quand on clique sur un marqueur, √ßa compte comme un clic sur la carte
                    marker.addListener('click', () => {
                        handleMapClick({ lat: () => city.lat, lng: () => city.lng });
                    });

                    // Afficher les indices (InfoWindow) seulement en super_easy
                    if (showTooltip) {
                        marker.addListener('mouseover', () => {
                            infowindow.open(map, marker);
                        });

                        marker.addListener('mouseout', () => {
                            infowindow.close();
                        });
                    }

                    gameState.cityMarkers.push(marker);
                }
            });
        }

        function displayCurrentCity() {
            const city = cities[gameState.currentCityIndex];
            document.getElementById('cityName').textContent = city.name;
            document.getElementById('current').textContent = gameState.currentCityIndex + 1;
            document.getElementById('scoreDisplay').textContent = gameState.score;

            // Afficher les marqueurs des villes si mode "cities"
            displayCityMarkers();

            // Ne pas centrer sur la ville - garder la vue g√©n√©rale de l'Allemagne
            // pour ne pas donner d'indice sur la localisation
        }

        function handleMapClick(latLng) {
            // Ignorer les clics si on attend d√©j√† un feedback
            if (gameState.isWaitingForFeedback) {
                return;
            }

            gameState.isWaitingForFeedback = true;

            const city = cities[gameState.currentCityIndex];
            const distance = calculateDistance(
                city.lat, city.lng,
                latLng.lat(), latLng.lng()
            );

            const radiusKm = gameState.toleranceRadius[gameState.difficulty];
            const isCorrect = distance <= radiusKm;

            // Supprimer l'ancien cercle utilisateur s'il existe
            if (userMarker) userMarker.setMap(null);
            
            // Cr√©er un cercle pour marquer le clic
            const markerColor = isCorrect ? '#4CAF50' : '#f44336';
            userMarker = new google.maps.Circle({
                center: latLng,
                radius: 5000, // 5km de rayon pour le marqueur
                map: map,
                fillColor: markerColor,
                fillOpacity: 0.7,
                strokeColor: 'white',
                strokeWeight: 2,
                strokeOpacity: 0.8
            });

            // Afficher le feedback
            showFeedback(isCorrect, distance, radiusKm);
            gameState.answers.push({ city: city.name, correct: isCorrect, distance });

            if (isCorrect) {
                gameState.score += Math.max(0, 100 - Math.round(distance));
            }
        }

        function showFeedback(isCorrect, distance, radius) {
            const feedback = document.getElementById('feedback');
            const title = document.getElementById('feedbackTitle');
            const text = document.getElementById('feedbackText');

            if (isCorrect) {
                feedback.className = 'feedback show correct';
                title.textContent = '‚úÖ Korrekt!';
                const points = Math.max(0, 100 - Math.round(distance));
                text.textContent = `${points} Punkte! (${distance.toFixed(1)} km entfernt)`;
            } else {
                feedback.className = 'feedback show incorrect';
                title.textContent = '‚ùå Falsch!';
                text.textContent = `${distance.toFixed(1)} km entfernt! Grenzwert: ${radius} km`;
            }
        }

        function nextCity() {
            document.getElementById('feedback').classList.remove('show');
            gameState.isWaitingForFeedback = false;
            gameState.currentCityIndex++;

            if (gameState.currentCityIndex >= cities.length) {
                endGame();
            } else {
                displayCurrentCity();
            }
        }

        function endGame() {
            const results = document.getElementById('resultsScreen');
            document.getElementById('finalScore').textContent = gameState.score;

            let breakdown = '<h3 style="color: white; text-align: center;">Ergebnisse:</h3>';
            gameState.answers.forEach((answer, index) => {
                const className = answer.correct ? 'correct' : 'incorrect';
                const icon = answer.correct ? '‚úÖ' : '‚ùå';
                breakdown += `
                    <div class="score-item ${className}">
                        <span>${index + 1}. ${answer.city}</span>
                        <span>${icon} ${answer.distance.toFixed(1)} km</span>
                    </div>
                `;
            });
            document.getElementById('scoreBreakdown').innerHTML = breakdown;
            results.classList.add('show');
        }

        function restartGame() {
            gameState.currentCityIndex = 0;
            gameState.score = 0;
            gameState.answers = [];
            gameState.isWaitingForFeedback = false;
            document.getElementById('resultsScreen').classList.remove('show');
            if (userMarker) userMarker.setMap(null);
            displayCurrentCity();
        }

        function changeDifficulty(level) {
            gameState.difficulty = level;
            displayCurrentCity();
        }

        function changeGameMode(mode) {
            gameState.gameMode = mode;
            displayCurrentCity();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Initialiser la carte au chargement
        // G√©r√© par waitForGoogleMaps() apr√®s le chargement de Google Maps
    </script>
</body>
</html>
