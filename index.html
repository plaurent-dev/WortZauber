<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wortzauber - Magie der WÃ¶rter</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link id="styleLink" rel="stylesheet" href="styles.css">
</head>

<body>

<!-- Navbar -->
<nav class="navbar">
    <div class="navbar-content">
        <h1>âœ¨ Wortzauber</h1>
        <div class="navbar-buttons">
            <div class="dropdown">
                <button class="navbar-link dropdown-toggle">ğŸ“– Ãœbungen â–¼</button>
                <div class="dropdown-menu">
                    <a href="ubungen.html" class="dropdown-item">âš¡ Alle Ãœbungen</a>
                    <hr style="margin: 5px 0; border: none; border-top: 1px solid #ddd;">
                    <a href="leselekture.html" class="dropdown-item">ğŸ“– LeselektÃ¼re</a>
                    <a href="revision_heures.html" class="dropdown-item">ğŸ• Uhrentraining</a>
                    <a href="revision_vocabulaire.html" class="dropdown-item">ğŸ“š Vokabeltraining</a>
                    <a href="revision_positions.html" class="dropdown-item">ğŸ—ºï¸ RÃ¤umliche Positionen</a>
                    <!-- Verbes dÃ©sactivÃ©s pour le moment
                    <a href="revision_irregulier_verbes.html" class="dropdown-item">UnregelmÃ¤ÃŸige Verben</a>
                    <a href="revision_regulier_verbes.html" class="dropdown-item">RegelmÃ¤ÃŸige Verben</a>
                    <a href="visualiseur_verbes.html" class="dropdown-item">Alle Verben</a>
                    -->
                    </div>
            </div>
            <button id="styleToggle" class="style-toggle-btn" title="Design-Stil wechseln">ğŸ¨ Soft</button>
            <a href="admin.html" class="navbar-link" id="loginBtn" style="background: #ffc107; color: #333;">ğŸ” Anmelden</a>
            <a href="admin.html" class="navbar-link admin" id="adminLink" style="display: none;">âš™ï¸ Admin</a>
            
            <div class="navbar-right">
                <span class="user-info" id="userDisplay" style="display: none;">
                    <span id="userEmail"></span>
                </span>
                <button class="navbar-link" id="logoutBtn" style="display: none;" onclick="logout()">ğŸ”“ Abmelden</button>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <h1 style="margin-top: 0;">Wortzauber - Magie der WÃ¶rter</h1>
    <p class="subtitle">Intelligente Sprachtraining fÃ¼r Fremdsprachen (A1)</p>

    <!-- Section LeselektÃ¼re -->
    <div class="section">
        <h2>ğŸ“– LeselektÃ¼re</h2>
        <div class="fiches-grid" id="leselektureContainer"></div>
    </div>
</div>

<script>
    // Charger les fiches depuis le fichier JSON central
    async function chargerFichesFromJSON() {
        try {
            const response = await fetch('articles.json');
            if (!response.ok) throw new Error('Erreur de chargement');
            return await response.json();
        } catch (e) {
            return [];
        }
    }

    // Afficher les fiches rÃ©centes (modifiÃ© pour async)
    async function afficherFichesRecentes() {
        const fiches = await chargerFichesFromJSON();
        const container = document.getElementById('fichesRecentes');

        if (fiches.length === 0) {
            return;
        }

        const fichesRecentes = fiches.slice(0, 6);

        container.innerHTML = fichesRecentes.map(fiche => `
            <div class="fiche-card" data-fiche="${fiche.href}">
                <h3>${fiche.region}</h3>
                <p class="date">ğŸ“… ${formaterDate(fiche.date)}</p>
                <button onclick="lancerFiche('${fiche.href}')">ğŸš€ Ã–ffnen</button>
            </div>
        `).join('');

        // Charger les images aprÃ¨s le rendu
        fichesRecentes.forEach(fiche => {
            fetch(fiche.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const img = doc.querySelector('img');
                    if (img && img.src) {
                        const card = document.querySelector(`[data-fiche="${fiche.href}"]`);
                        if (card && !card.querySelector('.fiche-image')) {
                            const imgElement = document.createElement('img');
                            imgElement.src = img.src;
                            imgElement.className = 'fiche-image';
                            card.insertBefore(imgElement, card.firstChild);
                        }
                    }
                })
                .catch(e => console.log('Impossible de charger l\'image'));
        });
    }

    // Rechercher des fiches (modifiÃ© pour async)
    async function rechercherFiches() {
        const region = document.getElementById('searchRegion').value.trim().toLowerCase();
        const date = document.getElementById('searchDate').value;

        const fiches = await chargerFichesFromJSON();

        let resultats = fiches;

        if (region) {
            resultats = resultats.filter(f => f.region.toLowerCase().includes(region));
        }

        if (date) {
            resultats = resultats.filter(f => f.date === date);
        }

        afficherResultats(resultats);
    }

    // Afficher les rÃ©sultats de recherche
    function afficherResultats(fiches) {
        const container = document.getElementById('resultatsRecherche');

        if (fiches.length === 0) {
            container.innerHTML = '<p style="color: #999; font-style: italic; margin-top: 20px;">Keine Lektionen gefunden.</p>';
            return;
        }

        container.innerHTML = `
            <h3>Ergebnisse (${fiches.length} Lektion${fiches.length > 1 ? 'en' : ''})</h3>
            <div class="fiches-grid" style="margin-top: 20px;">
                ${fiches.map(fiche => `
                    <div class="fiche-card" data-fiche="${fiche.href}">
                        <h3>${fiche.region}</h3>
                        <p class="date">ğŸ“… ${formaterDate(fiche.date)}</p>
                        <button onclick="lancerFiche('${fiche.href}')">ğŸš€ Ã–ffnen</button>
                    </div>
                `).join('')}
            </div>
        `;

        // Charger les images aprÃ¨s le rendu
        fiches.forEach(fiche => {
            fetch(fiche.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const img = doc.querySelector('img');
                    if (img && img.src) {
                        const card = document.querySelector(`[data-fiche="${fiche.href}"]`);
                        if (card && !card.querySelector('.fiche-image')) {
                            const imgElement = document.createElement('img');
                            imgElement.src = img.src;
                            imgElement.className = 'fiche-image';
                            card.insertBefore(imgElement, card.firstChild);
                        }
                    }
                })
                .catch(e => console.log('Impossible de charger l\'image'));
        });
    }

    // RÃ©initialiser la recherche
    function reinitialiserRecherche() {
        document.getElementById('searchRegion').value = '';
        document.getElementById('searchDate').value = '';
        document.getElementById('resultatsRecherche').innerHTML = '';
    }

    // Supprimer une fiche
    function supprimerFiche(nomFichier) {
        alert("La suppression doit maintenant Ãªtre faite manuellement dans le fichier articles.json.");
        // Pour automatiser, il faudrait un backend (PHP, Node, etc.)
    }

    // Lancer une fiche
    function lancerFiche(href) {
        window.open(href, '_blank');
    }

    // Formater la date
    function formaterDate(dateStr) {
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
    }

    // VÃ©rifier la connexion et mettre Ã  jour la navbar
    function updateNavbar() {
        const userEmail = sessionStorage.getItem('userEmail');
        const adminLink = document.getElementById('adminLink');
        const loginBtn = document.getElementById('loginBtn');
        const userDisplay = document.getElementById('userDisplay');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmailSpan = document.getElementById('userEmail');

        if (userEmail) {
            loginBtn.style.display = 'none';
            adminLink.style.display = 'inline-block';
            userDisplay.style.display = 'block';
            logoutBtn.style.display = 'inline-block';
            userEmailSpan.textContent = userEmail;
        } else {
            loginBtn.style.display = 'inline-block';
            adminLink.style.display = 'none';
            userDisplay.style.display = 'none';
            logoutBtn.style.display = 'none';
        }
    }

    // Fonction logout
    function logout() {
        sessionStorage.removeItem('userEmail');
        updateNavbar();
        afficherFichesRecentes();
    }

    // Google Maps
    const villesNL = {
        "Nijmegen": { lat: 51.842, lng: 5.852 },
        "Rotterdam": { lat: 51.922, lng: 4.479 },
        "Den Haag": { lat: 52.070, lng: 4.300 },
        "Amsterdam": { lat: 52.370, lng: 4.895 },
    "Leeuwarden": { lat: 53.201, lng: 5.799 },
    "Emmen": { lat: 52.785, lng: 6.897 },
    "Middelburg": { lat: 51.498, lng: 3.610 }
        // Ajoute d'autres villes ici si besoin
    };

    async function afficherMarqueursGoogleMap() {
        const articles = await chargerFichesFromJSON();
        const map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 52.1, lng: 5.2 },
            zoom: 8,
            mapTypeId: 'roadmap'
        });

        // Regrouper les articles par ville
        const articlesParVille = {};
        articles.forEach(article => {
            if (!articlesParVille[article.region]) {
                articlesParVille[article.region] = [];
            }
            articlesParVille[article.region].push(article);
        });

        Object.keys(articlesParVille).forEach(ville => {
            const coords = villesNL[ville];
            if (coords) {
                const articlesVille = articlesParVille[ville];
                const marker = new google.maps.Marker({
                    position: coords,
                    map: map,
                    title: `${ville} (${articlesVille.length} article${articlesVille.length > 1 ? 's' : ''})`
                });

                const content = `
                    <div>
                        <strong>${ville}</strong><br>
                        ${articlesVille.map(a => 
                            `<a href="${a.href}" target="_blank">${a.date} : ${a.titre ? a.titre : 'Voir l\'article'}</a>`
                        ).join('<br>')}
                    </div>
                `;
                const infowindow = new google.maps.InfoWindow({ content });

                marker.addListener('click', () => {
                    infowindow.open(map, marker);
                });
            }
        });
    }

    window.onload = function() {
        updateNavbar();
        afficherFichesRecentes();
        afficherLeselekturen();
        afficherMarqueursGoogleMap();
        initThemeToggle();
    };

    // ============================================
    // THEME SWITCHER
    // ============================================
    function initThemeToggle() {
        const styleLink = document.getElementById('styleLink');
        const toggleBtn = document.getElementById('styleToggle');
        const savedTheme = localStorage.getItem('wortzauber-theme') || 'modern';
        
        // Appliquer le thÃ¨me sauvegardÃ©
        applyTheme(savedTheme);
        
        // Event listener pour le bouton
        toggleBtn.addEventListener('click', function() {
            const currentTheme = localStorage.getItem('wortzauber-theme') || 'modern';
            const newTheme = currentTheme === 'modern' ? 'soft' : 'modern';
            applyTheme(newTheme);
            localStorage.setItem('wortzauber-theme', newTheme);
        });
    }

    function applyTheme(themeName) {
        const styleLink = document.getElementById('styleLink');
        const toggleBtn = document.getElementById('styleToggle');
        
        if (themeName === 'soft') {
            styleLink.href = 'styles-soft.css';
            toggleBtn.textContent = 'ğŸ¨ Modern';
            toggleBtn.setAttribute('title', 'Wechsel zu modernem Design');
        } else {
            styleLink.href = 'styles.css';
            toggleBtn.textContent = 'ğŸ¨ Soft';
            toggleBtn.setAttribute('title', 'Wechsel zu weichem Design');
        }
    }

    // ====== LESELEKTÃœRE ======
    async function afficherLeselekturen() {
        try {
            const response = await fetch('leselekture.json');
            const data = await response.json();
            const container = document.getElementById('leselektureContainer');

            if (!data.leselekturen || data.leselekturen.length === 0) {
                return;
            }

            const leselekturen = data.leselekturen;

            container.innerHTML = leselekturen.map(text => `
                <div class="fiche-card" onclick="window.location.href='leselekture.html?id=${text.id}'">
                    <h3>${text.titel}</h3>
                    <p class="date">ğŸ“– ${text.fragen.length} Fragen</p>
                    <p style="font-size: 0.9em; color: var(--text-medium); line-height: 1.4; height: 60px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
                        ${text.text.substring(0, 120)}...
                    </p>
                    <button onclick="window.location.href='leselekture.html?id=${text.id}'">ğŸ“š Ã–ffnen</button>
                </div>
            `).join('');
        } catch (error) {
            console.error('Erreur lors du chargement des leselekturen:', error);
        }
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYnaelzF3AanXmOGDG8j9kv3GyETYf1Js"></script>
</body>
</html>
