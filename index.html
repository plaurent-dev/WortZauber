<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Wortzauber - Magie der W√∂rter</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link id="styleLink" rel="stylesheet" href="styles.css?v=1.0.4">
    <script>
        // Version Manager - G√®re automatiquement le versioning des ressources
        const APP_VERSION = '1.0.4';
        document.addEventListener('DOMContentLoaded', function() {
            const links = document.querySelectorAll('link[rel="stylesheet"]');
            links.forEach(link => {
                const href = link.href;
                if ((href.includes('styles.css') || href.includes('styles-soft.css')) && !href.includes('googleapis')) {
                    if (href.includes('?v=')) {
                        link.href = href.replace(/\?v=[0-9.]+/, '?v=' + APP_VERSION);
                    } else {
                        link.href = href + (href.includes('?') ? '&v=' : '?v=') + APP_VERSION;
                    }
                }
            });
        });
    </script>
</head>

<body>

<!-- Dynamic Background -->
<div id="dynamicBackground" class="dynamic-background"></div>
<div id="imageInfo" class="image-info"></div>

<!-- Navbar -->
<nav class="navbar">
    <div class="navbar-content">
        <h1>‚ú® Wortzauber</h1>
        <div class="navbar-buttons">
            <div class="dropdown">
                <button class="navbar-link dropdown-toggle">üìñ √úbungen ‚ñº</button>
                <div class="dropdown-menu">
                    <a href="ubungen.html" class="dropdown-item">‚ö° Alle √úbungen</a>
                    <hr style="margin: 5px 0; border: none; border-top: 1px solid #ddd;">
                    <a href="leselekture.html" class="dropdown-item">üìñ Leselekt√ºre</a>
                    <a href="revision_heures.html" class="dropdown-item">üïê Uhrentraining</a>
                    <a href="revision_vocabulaire.html" class="dropdown-item">üìö Vokabeltraining</a>
                    <a href="revision_positions.html" class="dropdown-item">üó∫Ô∏è R√§umliche Positionen</a>
                    <!-- Verbes d√©sactiv√©s pour le moment
                    <a href="revision_irregulier_verbes.html" class="dropdown-item">Unregelm√§√üige Verben</a>
                    <a href="revision_regulier_verbes.html" class="dropdown-item">Regelm√§√üige Verben</a>
                    <a href="visualiseur_verbes.html" class="dropdown-item">Alle Verben</a>
                    -->
                    </div>
            </div>
            <a href="germannika.html" class="navbar-link" title="Germannika Ressourcen">üåê Germannika</a>
            <a href="admin.html" class="navbar-link admin" id="adminLink" style="display: none;">‚öôÔ∏è Admin</a>
            
            <div class="navbar-right">
                <span class="user-info" id="userDisplay" style="display: none;">
                    <span id="userEmail"></span>
                </span>
                <button class="navbar-link" id="logoutBtn" style="display: none;" onclick="logout()">üîì Abmelden</button>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <h1 style="margin-top: 0;">Wortzauber - Magie der W√∂rter</h1>
    <p class="subtitle">Intelligente Sprachtraining f√ºr Fremdsprachen (A1)</p>

    <!-- Section Leselekt√ºre -->
    <div class="section">
        <h2>üìñ Leselekt√ºre</h2>
        <div class="fiches-grid" id="leselektureContainer"></div>
    </div>
</div>

<script>
    // ====== DYNAMIC BACKGROUND WITH GERMAN CITIES ======
    const germanCities = [
        { name: 'Berlin', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
        { name: 'Munich', gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
        { name: 'Hamburg', gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
        { name: 'Cologne', gradient: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' },
        { name: 'Frankfurt', gradient: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' },
        { name: 'Stuttgart', gradient: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)' },
        { name: 'D√ºsseldorf', gradient: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' },
        { name: 'Dortmund', gradient: 'linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%)' },
        { name: 'Essen', gradient: 'linear-gradient(135deg, #2e2e78 0%, #2cb1bc 100%)' },
        { name: 'Leipzig', gradient: 'linear-gradient(135deg, #fad0c4 0%, #ffecd2 100%)' },
        { name: 'Dresden', gradient: 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)' },
        { name: 'Nuremberg', gradient: 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)' },
        { name: 'Hanover', gradient: 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)' },
        { name: 'Mannheim', gradient: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' },
        { name: 'Augsburg', gradient: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' },
        { name: 'Wuppertal', gradient: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)' },
        { name: 'Heidelberg', gradient: 'linear-gradient(135deg, #fbc2eb 0%, #a6c0fe 100%)' },
        { name: 'Potsdam', gradient: 'linear-gradient(135deg, #6dd5ed 0%, #2193b0 100%)' },
        { name: 'Freiburg', gradient: 'linear-gradient(135deg, #2e1a47 0%, #0f7c75 100%)' },
        { name: 'Bonn', gradient: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }
    ];

    const backgroundImages = [
        'url("data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27100%27 height=%27100%27%3E%3Cpath d=%27M20,20 L80,20 L80,80 L20,80 Z%27 stroke=%27%23fff%27 fill=%27none%27/%3E%3C/svg%3E")',
        'url("data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27100%27 height=%27100%27%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2730%27 stroke=%27%23fff%27 fill=%27none%27/%3E%3C/svg%3E")'
    ];

    // Tags pour recherche de paysages allemands
    const germanLandscapeTags = [
        'Germany,landscape',
        'German,castle',
        'Alps,mountain',
        'Black,forest',
        'Rhine,river',
        'German,countryside',
        'Bavaria,landscape',
        'German,architecture',
        'Berlin,city',
        'Munich,city'
    ];

    // Images locales de paysages allemands du dossier Background
    const cityImages = {
        'Berlin': 'Background/Germany-Frauenkirche-city-architecture-houses_2560x1440.jpg',
        'Munich': 'Background/Neuschwanstein-Castle-Bavaria-Germany-mountains-winter-snow-trees_1920x1200.jpg',
        'Hamburg': 'Background/Germany-Hamburg-river-water-castles_1920x1200.jpg',
        'Cologne': 'Background/Urban-landscape-Cologne-Germany-sunset-sky-the-Rhine-bridge-buildings_1600x1200.jpg',
        'Frankfurt': 'Background/Frankfurt-city-night-Germany-skyscrapers-river-bridge-illumination_1920x1200.jpg',
        'Stuttgart': 'Background/Lake-Starnberg-Bavaria-Germany-sunset-pier_1920x1200.jpg',
        'D√ºsseldorf': 'Background/Urban-landscape-Cologne-Germany-sunset-sky-the-Rhine-bridge-buildings_1600x1200.jpg',
        'Dortmund': 'Background/Baviere.png',
        'Essen': 'Background/BASF-Ludwigshafen-Germany_2880x1800.jpg',
        'Leipzig': 'Background/Leipzig-at-night-buildings-lights-Germany_3840x2160.jpg',
        'Dresden': 'Background/Dresden-Altstadt-Germany-city-building-houses_1920x1200.jpg',
        'Nuremberg': 'Background/Christmas-market-Annaberg-Buchholz-Germany_2880x1800.jpg',
        'Hanover': 'Background/Germany-city-house-river-summer-forest-mist_1920x1200.jpg',
        'Mannheim': 'Background/BASF-Ludwigshafen-Germany_2880x1800.jpg',
        'Augsburg': 'Background/Lake-Starnberg-Bavaria-Germany-sunset-pier_1920x1200.jpg',
        'Wuppertal': 'Background/Germany-Brannenburg-wood-house-trees-autumn_1920x1200.jpg',
        'Heidelberg': 'Background/Heidelberg-bridge-river-city-houses-Germany_5120x2880.jpg',
        'Potsdam': 'Background/Germany-Potsdam-street-city-buildings_3840x2160.jpg',
        'Freiburg': 'Background/Castle-Germany-night-lights-moon-trees_1920x1200.jpg',
        'Bonn': 'Background/Urban-landscape-Cologne-Germany-sunset-sky-the-Rhine-bridge-buildings_1600x1200.jpg'
    };

    // M√©tadonn√©es pour chaque image Background
    const imageMetadata = {
        'Background/BASF-Ludwigshafen-Germany_2880x1800.jpg': { city: 'Ludwigshafen', region: 'Rh√©nanie-Palatinat', description: 'Complexe BASF' },
        'Background/bavaria_sightseeing.jpg': { city: 'Bavi√®re', region: 'Bavi√®re', description: 'Paysage bavarois' },
        'Background/Baviere.png': { city: 'Bavi√®re', region: 'Bavi√®re', description: 'Sc√®ne bavaroise' },
        'Background/Castle-Germany-night-lights-moon-trees_1920x1200.jpg': { city: 'Ch√¢teau allemand', region: 'Saxe', description: 'Ch√¢teau de nuit' },
        'Background/Christmas-market-Annaberg-Buchholz-Germany_2880x1800.jpg': { city: 'Annaberg-Buchholz', region: 'Saxe', description: 'March√© de No√´l' },
        'Background/Dresden-Altstadt-Germany-city-building-houses_1920x1200.jpg': { city: 'Dresde', region: 'Saxe', description: 'Altstadt - Centre historique' },
        'Background/Frankfurt-city-night-Germany-skyscrapers-river-bridge-illumination_1920x1200.jpg': { city: 'Francfort', region: 'Hesse', description: 'Skyline de nuit' },
        'Background/Germany-Brannenburg-wood-house-trees-autumn_1920x1200.jpg': { city: 'Brannenburg', region: 'Bavi√®re', description: 'Maison foresti√®re' },
        'Background/Germany-city-house-river-summer-forest-mist_1920x1200.jpg': { city: 'For√™t allemande', region: 'Divers', description: 'Rivi√®re et for√™t' },
        'Background/Germany-Frauenkirche-city-architecture-houses_2560x1440.jpg': { city: 'Dresde/Berlin', region: 'Divers', description: 'Architecture allemande' },
        'Background/Germany-Hamburg-bridge-river-lights-buildings_1920x1200.jpg': { city: 'Hambourg', region: 'Hambourg', description: 'Pont illumin√©' },
        'Background/Germany-Hamburg-river-water-castles_1920x1200.jpg': { city: 'Hambourg', region: 'Hambourg', description: 'Ch√¢teaux sur l\'eau' },
        'Background/Germany-Potsdam-street-city-buildings_3840x2160.jpg': { city: 'Potsdam', region: 'Brandebourg', description: 'Rue de Potsdam' },
        'Background/Heidelberg-bridge-river-city-houses-Germany_5120x2880.jpg': { city: 'Heidelberg', region: 'Bade-Wurtemberg', description: 'Pont et rivi√®re' },
        'Background/Lake-Starnberg-Bavaria-Germany-sunset-pier_1920x1200.jpg': { city: 'Lac de Starnberg', region: 'Bavi√®re', description: 'Coucher de soleil' },
        'Background/Leipzig-at-night-buildings-lights-Germany_3840x2160.jpg': { city: 'Leipzig', region: 'Saxe', description: 'Ville de nuit' },
        'Background/Moritzburg-Castle-Saxony-Germany-water-reflection-night-lights_1920x1200.jpg': { city: 'Ch√¢teau de Moritzburg', region: 'Saxe', description: 'Ch√¢teau de nuit' },
        'Background/Neuschwanstein-Castle-Bavaria-Germany-mountains-winter-snow-trees_1920x1200.jpg': { city: 'Ch√¢teau de Neuschwanstein', region: 'Bavi√®re', description: 'Ch√¢teau mythique' },
        'Background/Urban-landscape-Cologne-Germany-sunset-sky-the-Rhine-bridge-buildings_1600x1200.jpg': { city: 'Cologne', region: 'Rh√©nanie du Nord-Westphalie', description: 'Cath√©drale et Rhin' }
    };

    function initDynamicBackground() {
        const bgElement = document.getElementById('dynamicBackground');
        const infoElement = document.getElementById('imageInfo');
        if (!bgElement) return;

        // S√©lectionner une ville al√©atoire
        const randomCity = germanCities[Math.floor(Math.random() * germanCities.length)];
        
        // Appliquer le gradient comme fond
        bgElement.style.background = randomCity.gradient;
        bgElement.style.backgroundSize = 'cover';
        bgElement.style.backgroundPosition = 'center';
        bgElement.style.backgroundAttachment = 'fixed';

        // Charger directement l'image
        const imageUrl = cityImages[randomCity.name];
        if (imageUrl) {
            const img = new Image();
            img.onload = function() {
                bgElement.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)), url('${imageUrl}')`;
                bgElement.style.backgroundSize = 'cover';
                bgElement.style.backgroundPosition = 'center';
                
                // Afficher les infos de l'image
                const metadata = imageMetadata[imageUrl];
                if (metadata && infoElement) {
                    infoElement.innerHTML = `
                        <div class="image-location">${metadata.city}</div>
                        <div class="image-region">${metadata.region} ‚Ä¢ ${metadata.description}</div>
                    `;
                }
            };
            img.onerror = function() {
                // Le gradient est d√©j√† appliqu√© comme fallback
            };
            img.src = imageUrl;
        }
    }

    // Initialiser le fond au chargement de la page
    window.addEventListener('load', function() {
        initDynamicBackground();
    });

    // Charger les fiches depuis le fichier JSON central
    async function chargerFichesFromJSON() {
        try {
            const response = await fetch('articles.json');
            if (!response.ok) throw new Error('Erreur de chargement');
            return await response.json();
        } catch (e) {
            return [];
        }
    }

    // Afficher les fiches r√©centes (modifi√© pour async)
    async function afficherFichesRecentes() {
        const fiches = await chargerFichesFromJSON();
        const container = document.getElementById('fichesRecentes');

        if (fiches.length === 0) {
            return;
        }

        const fichesRecentes = fiches.slice(0, 6);

        container.innerHTML = fichesRecentes.map(fiche => `
            <div class="fiche-card" data-fiche="${fiche.href}">
                <h3>${fiche.region}</h3>
                <p class="date">üìÖ ${formaterDate(fiche.date)}</p>
                <button onclick="lancerFiche('${fiche.href}')">üöÄ √ñffnen</button>
            </div>
        `).join('');

        // Charger les images apr√®s le rendu
        fichesRecentes.forEach(fiche => {
            fetch(fiche.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const img = doc.querySelector('img');
                    if (img && img.src) {
                        const card = document.querySelector(`[data-fiche="${fiche.href}"]`);
                        if (card && !card.querySelector('.fiche-image')) {
                            const imgElement = document.createElement('img');
                            imgElement.src = img.src;
                            imgElement.className = 'fiche-image';
                            card.insertBefore(imgElement, card.firstChild);
                        }
                    }
                })
                .catch(e => console.log('Impossible de charger l\'image'));
        });
    }

    // Rechercher des fiches (modifi√© pour async)
    async function rechercherFiches() {
        const region = document.getElementById('searchRegion').value.trim().toLowerCase();
        const date = document.getElementById('searchDate').value;

        const fiches = await chargerFichesFromJSON();

        let resultats = fiches;

        if (region) {
            resultats = resultats.filter(f => f.region.toLowerCase().includes(region));
        }

        if (date) {
            resultats = resultats.filter(f => f.date === date);
        }

        afficherResultats(resultats);
    }

    // Afficher les r√©sultats de recherche
    function afficherResultats(fiches) {
        const container = document.getElementById('resultatsRecherche');

        if (fiches.length === 0) {
            container.innerHTML = '<p style="color: #999; font-style: italic; margin-top: 20px;">Keine Lektionen gefunden.</p>';
            return;
        }

        container.innerHTML = `
            <h3>Ergebnisse (${fiches.length} Lektion${fiches.length > 1 ? 'en' : ''})</h3>
            <div class="fiches-grid" style="margin-top: 20px;">
                ${fiches.map(fiche => `
                    <div class="fiche-card" data-fiche="${fiche.href}">
                        <h3>${fiche.region}</h3>
                        <p class="date">üìÖ ${formaterDate(fiche.date)}</p>
                        <button onclick="lancerFiche('${fiche.href}')">üöÄ √ñffnen</button>
                    </div>
                `).join('')}
            </div>
        `;

        // Charger les images apr√®s le rendu
        fiches.forEach(fiche => {
            fetch(fiche.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const img = doc.querySelector('img');
                    if (img && img.src) {
                        const card = document.querySelector(`[data-fiche="${fiche.href}"]`);
                        if (card && !card.querySelector('.fiche-image')) {
                            const imgElement = document.createElement('img');
                            imgElement.src = img.src;
                            imgElement.className = 'fiche-image';
                            card.insertBefore(imgElement, card.firstChild);
                        }
                    }
                })
                .catch(e => console.log('Impossible de charger l\'image'));
        });
    }

    // R√©initialiser la recherche
    function reinitialiserRecherche() {
        document.getElementById('searchRegion').value = '';
        document.getElementById('searchDate').value = '';
        document.getElementById('resultatsRecherche').innerHTML = '';
    }

    // Supprimer une fiche
    function supprimerFiche(nomFichier) {
        alert("La suppression doit maintenant √™tre faite manuellement dans le fichier articles.json.");
        // Pour automatiser, il faudrait un backend (PHP, Node, etc.)
    }

    // Lancer une fiche
    function lancerFiche(href) {
        window.open(href, '_blank');
    }

    // Formater la date
    function formaterDate(dateStr) {
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
    }

    // V√©rifier la connexion et mettre √† jour la navbar
    function updateNavbar() {
        const userEmail = sessionStorage.getItem('userEmail');
        const adminLink = document.getElementById('adminLink');
        const userDisplay = document.getElementById('userDisplay');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmailSpan = document.getElementById('userEmail');

        if (userEmail) {
            adminLink.style.display = 'inline-block';
            userDisplay.style.display = 'block';
            logoutBtn.style.display = 'inline-block';
            userEmailSpan.textContent = userEmail;
        } else {
            adminLink.style.display = 'none';
            userDisplay.style.display = 'none';
            logoutBtn.style.display = 'none';
        }
    }

    // Fonction logout
    function logout() {
        sessionStorage.removeItem('userEmail');
        updateNavbar();
        afficherFichesRecentes();
    }

    window.onload = function() {
        updateNavbar();
        afficherFichesRecentes();
        afficherLeselekturen();
        initDynamicBackground();
    };

    // ====== LESELEKT√úRE ======
    async function afficherLeselekturen() {
        try {
            const response = await fetch('leselekture.json');
            const data = await response.json();
            const container = document.getElementById('leselektureContainer');

            if (!data.leselekturen || data.leselekturen.length === 0) {
                return;
            }

            // S√©lectionner 1 texte sur mobile, 2 sur desktop
            const isMobile = window.innerWidth <= 768;
            const numTexts = isMobile ? 1 : 2;
            const allTexts = data.leselekturen;
            const shuffled = allTexts.sort(() => 0.5 - Math.random());
            const leselekturen = shuffled.slice(0, numTexts);

            container.innerHTML = leselekturen.map(text => `
                <div class="fiche-card" onclick="window.location.href='leselekture.html?id=${text.id}'">
                    <h3>${text.titel}</h3>
                    <p class="date">üìñ ${text.fragen.length} Fragen</p>
                    <p style="font-size: 0.9em; color: var(--text-medium); line-height: 1.4; height: 60px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
                        ${text.text.substring(0, 120)}...
                    </p>
                    <button onclick="window.location.href='leselekture.html?id=${text.id}'">üìö √ñffnen</button>
                </div>
            `).join('');
        } catch (error) {
            console.error('Erreur lors du chargement des leselekturen:', error);
        }
    }
</script>
</body>
</html>
